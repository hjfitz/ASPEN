<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/auth/index.js - Documentation</title>

    <script src="scripts/hljs/highlight.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/hljs.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdmitPatient.html">AdmitPatient</a><ul class='methods'><li data-type='method'><a href="AdmitPatient.html#admit">admit</a></li><li data-type='method'><a href="AdmitPatient.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="AdmitPatient.html#getImg">getImg</a></li><li data-type='method'><a href="AdmitPatient.html#render">render</a></li><li data-type='method'><a href="AdmitPatient.html#setImg">setImg</a></li></ul></li><li><a href="App.html">App</a><ul class='methods'><li data-type='method'><a href="App.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="App.html#onChange">onChange</a></li><li data-type='method'><a href="App.html#render">render</a></li></ul></li><li><a href="global.html#Contact">Contact</a><ul class='methods'><li data-type='method'><a href="global.html#Contact#insert">insert</a></li><li data-type='method'><a href="global.html#Contact#populate">populate</a></li></ul></li><li><a href="CreateWard.html">CreateWard</a><ul class='methods'><li data-type='method'><a href="CreateWard.html#.validateForms">validateForms</a></li><li data-type='method'><a href="CreateWard.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="CreateWard.html#makeWard">makeWard</a></li><li data-type='method'><a href="CreateWard.html#render">render</a></li></ul></li><li><a href="DiagnosticReport.html">DiagnosticReport</a><ul class='methods'><li data-type='method'><a href="DiagnosticReport.html#fhir">fhir</a></li><li data-type='method'><a href="DiagnosticReport.html#fhirLinked">fhirLinked</a></li></ul></li><li><a href="Encounter.html">Encounter</a><ul class='methods'><li data-type='method'><a href="Encounter.html#delete">delete</a></li><li data-type='method'><a href="Encounter.html#fhir">fhir</a></li><li data-type='method'><a href="Encounter.html#insert">insert</a></li><li data-type='method'><a href="Encounter.html#populate">populate</a></li><li data-type='method'><a href="Encounter.html#update">update</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#.lookup">lookup</a></li><li data-type='method'><a href="Location.html#fhir">fhir</a></li><li data-type='method'><a href="Location.html#populate">populate</a></li></ul></li><li><a href="module.exports.html">exports</a></li><li><a href="NEWSError.html">NEWSError</a></li><li><a href="Observation.html">Observation</a><ul class='methods'><li data-type='method'><a href="Observation.html#fhir">fhir</a></li></ul></li><li><a href="OperationOutcome.html">OperationOutcome</a><ul class='methods'><li data-type='method'><a href="OperationOutcome.html#makeResponse">makeResponse</a></li></ul></li><li><a href="Patient.html">Patient</a><ul class='methods'><li data-type='method'><a href="Patient.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="Patient.html#delete">delete</a></li><li data-type='method'><a href="Patient.html#delete">delete</a></li><li data-type='method'><a href="Patient.html#fhir">fhir</a></li><li data-type='method'><a href="Patient.html#insert">insert</a></li><li data-type='method'><a href="Patient.html#populate">populate</a></li><li data-type='method'><a href="Patient.html#popupAE">popupAE</a></li><li data-type='method'><a href="Patient.html#popupHistory">popupHistory</a></li><li data-type='method'><a href="Patient.html#popupWarningScoreHistory">popupWarningScoreHistory</a></li><li data-type='method'><a href="Patient.html#render">render</a></li><li data-type='method'><a href="Patient.html#submitVitals">submitVitals</a></li><li data-type='method'><a href="Patient.html#update">update</a></li></ul></li><li><a href="Questionnaire.html">Questionnaire</a><ul class='methods'><li data-type='method'><a href="Questionnaire.html#toggleQuestionnaire">toggleQuestionnaire</a></li></ul></li><li><a href="Redirect.html">Redirect</a><ul class='methods'><li data-type='method'><a href="Redirect.html#componentWillMount">componentWillMount</a></li><li data-type='method'><a href="Redirect.html#render">render</a></li></ul></li><li><a href="SearchPatient.html">SearchPatient</a><ul class='methods'><li data-type='method'><a href="SearchPatient.html#componentWillUnmount">componentWillUnmount</a></li><li data-type='method'><a href="SearchPatient.html#render">render</a></li><li data-type='method'><a href="SearchPatient.html#renderPatients">renderPatients</a></li><li data-type='method'><a href="SearchPatient.html#search">search</a></li></ul></li><li><a href="Ward.html">Ward</a><ul class='methods'><li data-type='method'><a href="Ward.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="Ward.html#render">render</a></li><li data-type='method'><a href="Ward.html#renderPatients">renderPatients</a></li></ul></li><li><a href="WardList.html">WardList</a><ul class='methods'><li data-type='method'><a href="WardList.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="WardList.html#createWardList">createWardList</a></li><li data-type='method'><a href="WardList.html#render">render</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#AlcoholQuestionnaire">AlcoholQuestionnaire</a></li><li><a href="global.html#Breadcrumbs">Breadcrumbs</a></li><li><a href="global.html#calculate">calculate</a></li><li><a href="global.html#checkPass">checkPass</a></li><li><a href="global.html#createOutcome">createOutcome</a></li><li><a href="global.html#DecButton">DecButton</a></li><li><a href="global.html#decodeJWTPayload">decodeJWTPayload</a></li><li><a href="global.html#Diet">Diet</a></li><li><a href="global.html#dispatchMouseUp">dispatchMouseUp</a></li><li><a href="global.html#doModal">doModal</a></li><li><a href="global.html#DrugTable">DrugTable</a></li><li><a href="global.html#emulateTouch">emulateTouch</a></li><li><a href="global.html#Exercise">Exercise</a></li><li><a href="global.html#fhirBase">fhirBase</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#getCurrentUrl">getCurrentUrl</a></li><li><a href="global.html#getDate">getDate</a></li><li><a href="global.html#getGiven">getGiven</a></li><li><a href="global.html#getJwtPayload">getJwtPayload</a></li><li><a href="global.html#getPatientReport">getPatientReport</a></li><li><a href="global.html#getStyle">getStyle</a></li><li><a href="global.html#handleUser">handleUser</a></li><li><a href="global.html#HistoryReport">HistoryReport</a></li><li><a href="global.html#IncButton">IncButton</a></li><li><a href="global.html#Input">Input</a></li><li><a href="global.html#lengthPolicy">lengthPolicy</a></li><li><a href="global.html#Loader">Loader</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#noop">noop</a></li><li><a href="global.html#normalisePatientInfo">normalisePatientInfo</a></li><li><a href="global.html#normalisePatientReports">normalisePatientReports</a></li><li><a href="global.html#OtherQuestions">OtherQuestions</a></li><li><a href="global.html#PatientDemographicInfo">PatientDemographicInfo</a></li><li><a href="global.html#score">score</a></li><li><a href="global.html#scoreBP">scoreBP</a></li><li><a href="global.html#scoreCons">scoreCons</a></li><li><a href="global.html#scoreHeart">scoreHeart</a></li><li><a href="global.html#scoreOxy">scoreOxy</a></li><li><a href="global.html#scoreResp">scoreResp</a></li><li><a href="global.html#scoreSuppOxy">scoreSuppOxy</a></li><li><a href="global.html#scoreTemp">scoreTemp</a></li><li><a href="global.html#Select">Select</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#SignOff">SignOff</a></li><li><a href="global.html#toTitle">toTitle</a></li><li><a href="global.html#Welcome">Welcome</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/auth/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const authRouter = require('express').Router()
const request = require('request-promise')
const queryString = require('querystring')
const Base64 = require('crypto-js/enc-base64')
const Utf8 = require('crypto-js/enc-utf8')
const jwt = require('jsonwebtoken')
const bcrypt = require('bcrypt')

const checkPass = require('./passwords')
const logger = require('../logger')
const OperationOutcome = require('../fhir/classes/OperationOutcome')
const {knex} = require('../db')

// ! csprng is ideal - but not good for using nodemon in development. fix this later
const sessionSecret = process.env.AUTH_SECRET// = csprng(128, 26)
const saltRounds = 5 // has a big impact on perf

/**
 * Given user details, store them in the database, if they don't already exist
 * This is so that admins can assign wards
 * @param {string} payload unparsed json
 */
async function handleUser(payload) {
	const meta = {file: 'auth.js', func: 'handleUser()'}
	const parsed = JSON.parse(payload)
	const rows = await knex('practitioner')
		.select()
		.where({username: parsed.email})
	if (rows.length) {
		logger.debug('user exists. returning', meta)
		return rows[0]
	}
	logger.debug('creating new user', meta)
	const [resp] = await knex('practitioner').insert({
		name: parsed.name,
		added: new Date(),
		username: parsed.email,
		account_type: 'google',
		permissions: '[]',
	}).returning('*')
	logger.info(`user created with id: ${resp.practitioner_id}`, meta)
	return resp
}

/**
 * Google oauth flow. Environment variables required:
 *** GOOGLE_CLIENT_ID - Client ID from Google
 *** GOOGLE_CLIENT_SECRET - Client secret from Google
 *** GOOGLE_OAUTH_CALLBACK - The FULL URL for google to callback to. This set in app settings
 *** AUTH_SECRET - some password for the JWT
 * Implementation from https://developers.google.com/identity/protocols/OAuth2WebServer
 */
authRouter.get('/auth/callback', async (req, res) => {
	const meta = {file: 'auth.js', func: 'GET /auth/callback'}
	logger.info('recieved request from google', meta)
	// code? we must be authing
	logger.debug('attempting to login', meta)

	// Create request body
	const body = queryString.stringify({
		code: req.query.code,
		grant_type: 'authorization_code',
		client_id: process.env.GOOGLE_CLIENT_ID,
		client_secret: process.env.GOOGLE_CLIENT_SECRET,
		redirect_uri: encodeURI(process.env.GOOGLE_OAUTH_CALLBACK),
	})
	const opts = {
		body,
		method: 'POST',
		uri: 'https://www.googleapis.com/oauth2/v4/token',
		headers: {
			'Content-Length': body.length,
			'Content-Type': 'application/x-www-form-urlencoded',
		},
	}
	// send body to google and wait for AT/ID Token
	const resp = await request(opts)
	// can access google ACCESS_TOKEN here
	const {id_token} = JSON.parse(resp)

	// ID Token is a JWT, extract this and use it in our new JWT
	// create our own JWT because we know the pass and can verify it
	const [, payloadB64] = id_token.split('.')
	const payload = Utf8.stringify(Base64.parse(payloadB64))
	const {email, name, hd, given_name, family_name} = JSON.parse(payload)

	const userData = await handleUser(payload)
	// store user if not in database and add basic permissions + include in JWT
	const fypPayload = {
		email,
		userid: userData.practitioner_id,
		permissions: userData.permissions,
		name,
		hd,
		given_name,
		family_name,
		exp: Math.floor(Date.now() / 1000) + (60 * 60),
	}
	const token = jwt.sign(fypPayload, sessionSecret)

	// return the user to the homepage
	// sadly state in google's oauth response is not the previous url as it is with other servers
	res.redirect(`/?token=${token}`)

	// user has authed: handle their identity
})

// user gets redirected to /login: create a URL and redirect them to google's oauth server
authRouter.get('/login', (_, res) => {
	// if the user is not making a request with a token
	// or if we have not sent it to them, redirect to auth
	const url = 'https://accounts.google.com/o/oauth2/v2/auth?'
		+ 'state=state_parameter_passthrough_value&amp;'
		+ 'include_granted_scopes=true&amp;'
		+ 'access_type=offline&amp;'
		+ `redirect_uri=${encodeURIComponent(process.env.GOOGLE_OAUTH_CALLBACK)}&amp;`
		+ 'response_type=code&amp;'
		+ `client_id=${process.env.GOOGLE_CLIENT_ID}&amp;`
		+ `scope=${encodeURIComponent('profile email openid')}`
	res.redirect(url)
	// return res.redirect(`/login.html?google_redir=${url}`)
})

authRouter.get('/login/url', (req, res) => {
	const url = 'https://accounts.google.com/o/oauth2/v2/auth?'
		+ 'state=state_parameter_passthrough_value&amp;'
		+ 'include_granted_scopes=true&amp;'
		+ 'access_type=offline&amp;'
		+ `redirect_uri=${encodeURIComponent(process.env.GOOGLE_OAUTH_CALLBACK)}&amp;`
		+ 'response_type=code&amp;'
		+ `client_id=${process.env.GOOGLE_CLIENT_ID}&amp;`
		+ `scope=${encodeURIComponent('profile email openid')}`
	res.send(url)
})

// recieve login data from user
authRouter.post('/login', async (req, res) => {
	const {username, password} = req.body
	try {
		// check user in db. exclude google types
		const [row] = await knex('practitioner')
			.select()
			.where({username, account_type: 'normal'})
		// no user? inform
		if (!row) return res.status(400).send('Unable to login: username does not exist!')

		// compare the password with the hash stored in db. no match? reject
		const passMatch = await bcrypt.compare(password, row.passhash)
		if (!passMatch) return res.status(400).send('Passwords do not match')

		// create a JWT with name, username, ID and permissions.
		// expires in an hour, lecture length
		const token = jwt.sign({
			name: row.name,
			username: row.username,
			userid: row.practitioner_id,
			permissions: row.permissions,
			exp: Math.floor(Date.now() / 1000) + (60 * 60),
		}, sessionSecret)

		// message is shown in popup
		return res.json({token, message: `Welcome back, ${row.name}`})
	} catch (err) {
		// handle errors with a 500 so the server does not die
		return res.status(500).send(`Error logging in: ${err}`)
	}
})

authRouter.post('/login/create', async (req, res) => {
	// to create a user, name, username and password is required
	const required = ['name', 'username', 'password']
	// pull from request body
	const {name, username, password} = req.body

	// check we have all required entries
	const missing = required.filter(key => !req.body[key])
	if (missing.length) return res.status(400).send(`Couldn't register! Missing: ${missing.join(', ')}`)

	// check they don't already exist
	const rows = await knex('practitioner').select().where({username})
	if (rows.length) return res.status(400).send("Couldn't register! Username already exists")

	// check that password > 10 chars and includes alphanum]
	const {valid, message} = checkPass(password)
	if (!valid) return res.status(400).send(`Issue with password: ${message}`)

	try {
		// calculate a password hash and put in db
		const passhash = await bcrypt.hash(password, saltRounds)
		await knex('practitioner').insert({
			name,
			username,
			passhash,
			permissions: '[]', // knex with JSON rows still means that json must be stringified
			account_type: 'normal',
			added: new Date(),
		})
		return res.status(200).send(`Successfully registered. Welcome, ${name}`)
	} catch (err) {
		return res.status(500).send(`&lt;p>Couldn't register! Error:&lt;/p>&lt;p>${err}&lt;/p>`)
	}
})

// token checking middleware for fhir API
authRouter.use('/fhir', (req, res, next) => {
	const meta = {file: 'auth.js', func: 'auth middleware'}
	// extract token from headers
	const {token} = req.headers
	logger.debug(`has token: ${!!token}`, meta)
	logger.silly(`token: ${token}`, meta)
	// no token? login
	if (!token) return res.redirect('/login')
	try {
		// verify token with session secret
		const valid = jwt.verify(token, sessionSecret)
		logger.silly(`validated user token. allowing them through, ${JSON.stringify(valid)}`, meta)
		return next()
	} catch (err) {
		// error verifying token? redirect to login
		logger.debug('user not valid. informing client axios', meta)
		logger.error(`error caught: ${err}`, meta)
		const outcome = new OperationOutcome('error', 401, req.originalUrl, 'JWT invalid or inaccessible', err)
		return outcome.makeResponse(res)
	}
})


module.exports = authRouter
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Apr 26 2019 15:33:49 GMT+0100 (British Summer Time) using the <a href="https://github.com/contentful/contentful-sdk-jsdoc">contentful-sdk-jsdoc</a> theme.
</footer>

<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
