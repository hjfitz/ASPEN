<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">src/server/fhir/classes/Patient.js | fyp</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Final year project @portsoc"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="fyp"><meta property="twitter:description" content="Final year project @portsoc"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/hjfitz/fyp"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa">client/spa</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/WarningScore.js~WarningScore.html">WarningScore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-doModal">doModal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getJwtPayload">getJwtPayload</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getName">getName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-noop">noop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showLogin">showLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toTitle">toTitle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fhirBase">fhirBase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages">client/spa/pages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/create-ward.jsx~CreateWard.html">CreateWard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/permissions.jsx~Permissions.html">Permissions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/search-patients.jsx~SearchPatient.html">SearchPatient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/view-patient.jsx~Patient.html">Patient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/view-ward.jsx~Ward.html">Ward</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/ward-list.jsx~WardList.html">WardList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Add">Add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Welcome">Welcome</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-permissionsBase">permissionsBase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages-admit-patient">client/spa/pages/admit-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/History.jsx~CreateHistory.html">CreateHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/index.jsx~AdmitPatient.html">AdmitPatient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Contact">Contact</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PatientDemographicInfo">PatientDemographicInfo</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages-admit-patient-history">client/spa/pages/admit-patient/history</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/Questionnaire.jsx~Questionnaire.html">Questionnaire</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/alcohol.jsx~Alcohol.html">Alcohol</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/drugs.jsx~Drugs.html">Drugs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/health-history.jsx~HealthHistory.html">HealthHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/medication.jsx~Medication.html">Medication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/tobacco.jsx~Tobacco.html">Tobacco</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Diet">Diet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Exercise">Exercise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OtherQuestions">OtherQuestions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SignOff">SignOff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DecButton">DecButton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-IncButton">IncButton</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-admit-patient">client/spa/partial/admit-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/admit-patient/signature-box.jsx~Signature.html">Signature</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-layout">client/spa/partial/layout</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/fab.jsx~Fab.html">Fab</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/login.jsx~Login.html">Login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/redirect.jsx~Redirect.html">Redirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Breadcrumbs">Breadcrumbs</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-shared">client/spa/partial/shared</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Input">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Loader">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Modal">Modal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Select">Select</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-view-patient">client/spa/partial/view-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/view-patient/vital-signs.jsx~Vitals.html">Vitals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/view-patient/vitals-charts.jsx~NewsChart.html">NewsChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HistoryReport">HistoryReport</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-router">router</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-fhir">server/fhir</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-patientRouter">patientRouter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-fhir-classes">server/fhir/classes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Contact.js~Contact.html">Contact</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/DiagnosticReport.js~DiagnosticReport.html">DiagnosticReport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Encounter.js~Encounter.html">Encounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/FHIRBase.js~FHIRBase.html">FHIRBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Location.js~Location.html">Location</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Observation.js~Observation.html">Observation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/OperationOutcome.js~OperationOutcome.html">OperationOutcome</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Patient.js~Patient.html">Patient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Practitioner.js~Practitioner.html">Practitioner</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/fhir/classes/Patient.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const mimeTypes = require(&apos;mime-types&apos;)
const sha1 = require(&apos;crypto-js/sha1&apos;)
const fs = require(&apos;fs&apos;)
const path = require(&apos;path&apos;)
const shortid = require(&apos;shortid&apos;)
const mime = require(&apos;mime-types&apos;)


const logger = require(&apos;../../logger&apos;)
const {knex} = require(&apos;../../db&apos;)
const Contact = require(&apos;./Contact&apos;)
const FHIRBase = require(&apos;./FHIRBase&apos;)

class Patient extends FHIRBase {
	/**
	 * Fhir wrapper for patient information
	 * @param {object} params patient params
	 * @param {boolean} params.active whether the patient is still active in the hospital
	 * @param {string} params.id DB id for the patient
	 * @param {string} params.fullname fullname of patient
	 * @param {string} params.given patient family name
	 * @param {string} params.prefix patient prefix (Mr, Miss)
	 * @param {string} params.gender patient gender: male, female or other
	 * @param {Date} params.last_updated when the patient was last updated
	 * @param {string} params.photo_url where the patient url is stored
	 * @param {string} params.family patient family name (surname)
	 */
	constructor(params) {
		super(params)
		const {active, id, fullname, given, prefix, gender, last_updated, photo, family} = params
		this.active = active
		this.loaded = false
		this.id = id
		this.fullname = fullname
		this.given = given
		this.prefix = prefix
		this.gender = gender
		this.last_updated = last_updated
		this.photo = photo
		this.family = family
		this.meta = {file: &apos;fhir/classes/Patient.js&apos;}
		this.required = [&apos;active&apos;, &apos;fullname&apos;, &apos;given&apos;, &apos;prefix&apos;, &apos;gender&apos;, &apos;contact_id&apos;]
		this.values = [...this.required, &apos;family&apos;, &apos;last_updated&apos;]
	}

	/**
	 * Based on this.id, populate the patient with database info
	 * @return {boolean} populated or not
	 */
	async populate() {
		const {meta, id} = this
		if (!id) {
			logger.warn(&apos;Attempted to populate with invalid ID&apos;, meta)
			return false
		}
		try {
			const [patient] = await knex(&apos;patient&apos;).select().where({patient_id: id})
			this.loaded = true
			Object.keys(patient).forEach(key =&gt; this[key] = patient[key])
			this.contact = new Contact({contact_id: patient.contact_id})
			await this.contact.populate()
			return true
		} catch (err) {
			logger.error(&apos;Unable to populate patient&apos;, {...this.meta, func: &apos;populate()&apos;})
			logger.error(err, {...this.meta, func: &apos;populate()&apos;})
			return false
		}
	}

	/**
	 * Attempt to insert a patient with params provided
	 * @returns {boolean} inserted or not
	 */
	async insert() {
		const isValid = this.required.filter(key =&gt; !(this[key]))
		if (isValid.length) {
			logger.warn(&apos;unable to create patient&apos;, {...this.meta, func: &apos;insert()&apos;})
			logger.silly(JSON.stringify(isValid), {...this.meta, func: &apos;insert()&apos;})
			return false
		}
		// create object
		this.last_updated = new Date()
		this.active = true
		const obj = this.values.reduce((acc, cur) =&gt; {
			acc[cur] = this[cur]
			return acc
		}, {})
		if (this.photo &amp;&amp; this.photo.mv) {
			logger.info(&apos;handling image&apos;, {...this.meta, func: &apos;insert()&apos;})
			const ext = mime.extension(this.photo.mimetype)
			const photo_url = path.join(&apos;/patient&apos;, `${this.given}-${shortid.generate()}.${ext}`)
			const newPath = path.join(process.cwd(), photo_url)
			logger.debug(`moved image to ${newPath}`, {...this.meta, func: &apos;insert()&apos;})
			this.photo.mv(newPath)
			obj.photo_url = photo_url
		}
		// make query
		const [resp] = await knex(&apos;patient&apos;).insert(obj).returning([&apos;patient_id&apos;, ...this.values])
		return resp
	}

	/**
	 * Attempts to perform UPDATE on the database with this.id and params provided
	 * @returns {boolean} Updated or not
	 */
	async update() {
		const toUpdate = this.values
			.filter(val =&gt; this[val])
			.reduce((acc, cur) =&gt; {
				acc[cur] = this[cur]
				return acc
			}, {})
		if (Object.keys(toUpdate).length) {
			logger.warn(`Trying to update ${this.id}, but no params`, this.meta)
			return false
		}
		try {
			await knex(&apos;patient&apos;).update(toUpdate)
			logger.debug(`Successfully updated ${Object.keys(toUpdate).join(&apos;, &apos;)}`, this.meta)
			await this.populate()
		} catch (err) {
			logger.error(&apos;Unable to update patient&apos;, {...this.meta, func: &apos;update()&apos;})
			logger.error(err, {...this.meta, func: &apos;update()&apos;})
			return false
		}
		return true
	}

	/**
	 * Attempts to delete a patient based on this.id
	 * fetch patient photo URL so that this can be removed from the disk
	 * delete the patient from the database, then the image
	 * order is important, because if database delete fails, no more image for patient
	 * @returns {boolean} Deleted or nah
	 */
	async delete() {
		try {
			// get patient photo url from db
			const [row] = await knex(&apos;patient&apos;).select().where(&apos;patient_id&apos;, this.id)
			const url = path.join(process.cwd(), (row.photo_url || &apos;&apos;))
			// remove DB entry and then the associated image
			await knex(&apos;patient&apos;).delete(&apos;patient&apos;, this.id)
			logger.debug(`attempting to delete patient photo with url: ${url}`, this.meta)
			if (row.photo_url &amp;&amp; fs.existsSync(url)) fs.unlinkSync(url)
			return {deleted: true, msg: &apos;Successfully deleted patient&apos;}
		} catch (err) {
			logger.error(&apos;Unable to delete patient&apos;, {...this.meta, func: &apos;delete()&apos;})
			logger.error(err, {...this.meta, func: &apos;delete()&apos;})
			return {deleted: false, msg: err}
		}
	}

	/**
	 * Formats patient to standard fhir patient
	 * @returns {object} patient info formatted in fhir
	 */
	async fhir() {
		await this.populate()
		const {contact} = this
		if (!contact) return false
		const local = path.join(process.cwd(), this.photo_url || &apos;&apos;)
		const photo = this.photo_url &amp;&amp; fs.existsSync(local)
			? [{
				contentType: mimeTypes.lookup(local),
				url: this.photo_url,
				hash: sha1(fs.readFileSync(local)).toString(),
			}]
			: []
		return {
			identifier: [{
				use: &apos;usual&apos;,
				system: &apos;urn:ietf:rfc:3986&apos;,
				value: &apos;database id&apos;,
				assigner: &apos;SoN&apos;,
			}],
			resourceType: &apos;Patient&apos;,
			id: this.id,
			active: this.active,
			name: [{
				use: &apos;usual&apos;,
				text: this.fullname,
				family: this.family,
				given: this.given,
				prefix: this.prefix.split(&apos; &apos;),
			}],
			gender: this.gender,
			photo,
			contact: [{
				name: {
					use: &apos;usual&apos;,
					text: contact.fullname,
					family: contact.family,
					given: contact.given,
					prefix: contact.prefix.split(&apos; &apos;),
				},
				telecom: [{
					system: &apos;phone&apos;,
					value: contact.phone,
					use: &apos;home&apos;,
				}],
			}],
		}
	}
}

module.exports = Patient
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
