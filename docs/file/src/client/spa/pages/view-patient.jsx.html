<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../">
  <title data-ice="title">src/client/spa/pages/view-patient.jsx | fyp</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Final year project @portsoc"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="fyp"><meta property="twitter:description" content="Final year project @portsoc"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/hjfitz/fyp"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa">client/spa</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/WarningScore.js~WarningScore.html">WarningScore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-doModal">doModal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getJwtPayload">getJwtPayload</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getName">getName</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-noop">noop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-showLogin">showLogin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toTitle">toTitle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fhirBase">fhirBase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages">client/spa/pages</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/create-ward.jsx~CreateWard.html">CreateWard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/permissions.jsx~Permissions.html">Permissions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/search-patients.jsx~SearchPatient.html">SearchPatient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/view-patient.jsx~Patient.html">Patient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/view-ward.jsx~Ward.html">Ward</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/ward-list.jsx~WardList.html">WardList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Add">Add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Welcome">Welcome</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-permissionsBase">permissionsBase</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages-admit-patient">client/spa/pages/admit-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/History.jsx~CreateHistory.html">CreateHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/index.jsx~AdmitPatient.html">AdmitPatient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Contact">Contact</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PatientDemographicInfo">PatientDemographicInfo</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-pages-admit-patient-history">client/spa/pages/admit-patient/history</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/Questionnaire.jsx~Questionnaire.html">Questionnaire</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/alcohol.jsx~Alcohol.html">Alcohol</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/drugs.jsx~Drugs.html">Drugs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/health-history.jsx~HealthHistory.html">HealthHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/medication.jsx~Medication.html">Medication</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/pages/admit-patient/history/tobacco.jsx~Tobacco.html">Tobacco</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Diet">Diet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Exercise">Exercise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-OtherQuestions">OtherQuestions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-SignOff">SignOff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DecButton">DecButton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-IncButton">IncButton</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-admit-patient">client/spa/partial/admit-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/admit-patient/signature-box.jsx~Signature.html">Signature</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-layout">client/spa/partial/layout</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/fab.jsx~Fab.html">Fab</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/login.jsx~Login.html">Login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/layout/redirect.jsx~Redirect.html">Redirect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Breadcrumbs">Breadcrumbs</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-shared">client/spa/partial/shared</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Input">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Loader">Loader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Modal">Modal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Select">Select</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#client-spa-partial-view-patient">client/spa/partial/view-patient</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/view-patient/vital-signs.jsx~Vitals.html">Vitals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/spa/partial/view-patient/vitals-charts.jsx~NewsChart.html">NewsChart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-HistoryReport">HistoryReport</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server">server</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-router">router</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-fhir">server/fhir</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-patientRouter">patientRouter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#server-fhir-classes">server/fhir/classes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Contact.js~Contact.html">Contact</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/DiagnosticReport.js~DiagnosticReport.html">DiagnosticReport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Encounter.js~Encounter.html">Encounter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/FHIRBase.js~FHIRBase.html">FHIRBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Location.js~Location.html">Location</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Observation.js~Observation.html">Observation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/OperationOutcome.js~OperationOutcome.html">OperationOutcome</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Patient.js~Patient.html">Patient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/fhir/classes/Practitioner.js~Practitioner.html">Practitioner</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/client/spa/pages/view-patient.jsx</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {h, Component} from &apos;preact&apos;
import M from &apos;materialize-css&apos;
import {Loader, Vitals, HistoryReport, VitalCharts} from &apos;../Partial&apos;
import {fhirBase, doModal, toTitle} from &apos;../util&apos;
import WarningScore from &apos;../WarningScore&apos;

import &apos;../styles/view-patient.scss&apos;
/**
 * Normalise api response for ease of manipulation in this component
 * @param {object} fhirResponse API response
 * @returns {object} normalised fhir response
 */
const normalisePatientInfo = (fhirResponse) =&gt; {
	const {
		contact: [contact],
		photo: [photo],
		name: [name],
		id,
		gender,
		reference,
	} = fhirResponse
	return ({
		patient: {
			displayName: `${name.prefix} ${name.text}`,
			photo: photo ? photo.url : &apos;&apos;,
			id,
			gender,
			location: reference,
		},
		contact: {
			displayName: `${contact.name.prefix} ${contact.name.text}`,
			number: contact.telecom[0].value,
		},

	})
}

/**
 * makes the fhir response easier to work with
 * @param {object[]} patReport Patient diagnostic report fro fhir api
 * @returns {object[]} formatted object: [{oxygen_saturation: 11, body_temp: 37 ...}]
 */
const normalisePatientReports = patReport =&gt; patReport
	.map(report =&gt; ({
		...report.result.reduce((acc, cur) =&gt; {
			acc[cur.code.text] = cur.valueQuantity.value
			return acc
		}, {}),
		date: new Date(report.meta.lastUpdated)}
	))


/**
 * Hit /Diagnostics for list of 10 most recent patient reports
 * @param {number} id patient ID
 * @param {number} pageNo which page number to visit
 * @returns {AxiosPromise&lt;any&gt;} request to API
 */
const getPatientReport = (id, pageNo = 0) =&gt; fhirBase.get(
	`Diagnostics?patient=${id}`
	+ &apos;&amp;result=true&apos;
	+ &apos;&amp;_count=10&apos;
	+ `&amp;pageNo=${pageNo}`,
)

class Patient extends Component {
	/**
	 * Patient information component
	 * @param {object} props component props
	 */
	constructor(props) {
		super(props)
		this.state = {
			loaded: false,
			patientInfo: null,
			pageNo: 0,
			report: {},
			reportLoaded: false,
		}
		this.submitVitals = this.submitVitals.bind(this)
	}

	/**
	 * fetch patient data from /Encounter on form load
	 */
	async componentDidMount() {
		const {patient_id: id} = this.props
		const [{data}, {data: patientReport}] = await Promise.all([
			fhirBase.get(`Encounter?class=admission&amp;patient_id=${id}&amp;_include=Encounter:patient`),
			getPatientReport(id, this.state.pageNo),
		])

		const patientInfo = normalisePatientInfo({...data[0].subject, ...data[0].location[0]})
		const patientReports = normalisePatientReports(patientReport) // comes pre-sorted from API
		const ews = new WarningScore(patientReports[0])
		this.setState({
			patientInfo,
			loaded: true,
			patientReports,
			news: ews.score(),
		})
	}


	/**
	 * Submit data to API and repopulate vital chart
	 * @param {FormData} diagnosticReport fields in &lt;vitals /&gt;
	 */
	async submitVitals(diagnosticReport) {
		diagnosticReport.append(&apos;patient_id&apos;, this.props.patient_id)
		try {
			const {data} = await fhirBase.post(&apos;/Diagnostics&apos;, diagnosticReport)
			M.toast({html: data.details.text})
			const {data: patientReport} = await getPatientReport(this.props.patient_id, this.state.pageNo)
			const patientReports = normalisePatientReports(patientReport)
			const ews = new WarningScore(patientReports[0])
			this.setState({
				loaded: true,
				patientInfo: this.state.patientInfo,
				patientReports,
				news: ews.score(),
			})
		} catch (err) {
			console.error(err.response)
			doModal(&apos;Error&apos;, `There was an error submitting this report:&lt;/p&gt;&lt;p&gt;${err}&lt;/p&gt;`)
		}
	}

	/**
	 * ? Keep an eye on `history.back`, see if it malfunctions
	 */
	async delete() {
		const {data} = await fhirBase.delete(`/Patient/${this.props.patient_id}`)
		const sev = data.issue[0].severity
		doModal(toTitle(sev), data.issue[0].details.text)
		if (sev === &apos;success&apos;) window.history.back()
	}

	/**
	 * get history data and then update state
	 * once state is updated, can be passed to history component as props via re-render
	 * after this, pop-up the modal
	 * @param {Event} ev click
	 */
	async popupHistory(ev) {
		ev.preventDefault()
		const {patient_id} = this.props
		const {data: report} = await fhirBase.get(`/History/${patient_id}`)
		this.setState({
			loaded: this.state.loaded,
			patientInfo: this.state.patientInfo,
			patientReports: this.state.patientReports,
			news: this.state.news,
			report,
			reportLoaded: true,
		}, () =&gt; {
			const repModal = document.querySelector(&apos;.modal.history-report-modal&apos;)
			const instance = M.Modal.getInstance(repModal) || M.Modal.init(repModal)
			instance.open()
		})
	}

	/**
	 * invoked on click of A-E
	 * placeholder until invoked
	 * @param {Event} ev Click event
	 */
	async popupAE(ev) {
		ev.preventDefault()
		console.log(this)
	}

	/**
	 * pop up a modal and update tabs
	 * @param {Event} ev click event
	 */
	popupWarningScoreHistory(ev) {
		ev.preventDefault()
		const instance = M.Modal.getInstance(this.newsChart) || M.Modal.init(this.newsChart, {
			onOpenEnd() {
				const tabs = document.querySelector(&apos;.tabs.chart-tabs&apos;)
				M.Tabs.init(tabs)
				console.log(&apos;opening tabs&apos;)
			},
		})
		instance.open()
	}

	/**
	 * Render our patient info
	 * @returns {preact.VNode} patient information or loading icon
	 */
	render() {
		if (!this.state.loaded) return &lt;Loader /&gt;
		const {patient, contact} = this.state.patientInfo
		return (
			&lt;div className=&quot;row&quot;&gt;
				&lt;div className=&quot;col s12&quot;&gt;
					&lt;div className=&quot;card horizontal patient-view&quot;&gt;
						&lt;div className=&quot;card-image&quot;&gt;
							&lt;img alt={patient.displayName} src={patient.photo || &apos;/img/patient-placeholder.webp&apos;} /&gt;
						&lt;/div&gt;
						&lt;div className=&quot;card-stacked&quot;&gt;
							&lt;div className=&quot;card-content&quot;&gt;
								&lt;i className=&quot;material-icons right clickable&quot; onClick={this.delete.bind(this)}&gt;close&lt;/i&gt;
								&lt;div className=&quot;row&quot;&gt;
									&lt;div className=&quot;col s12&quot;&gt;
										&lt;span className=&quot;card-title&quot;&gt;{patient.displayName}&lt;/span&gt;
									&lt;/div&gt;
								&lt;/div&gt;
								&lt;div className=&quot;row&quot;&gt;
									&lt;div className=&quot;col s6&quot;&gt;
										&lt;h6&gt;Patient Information&lt;/h6&gt;
										&lt;p&gt;&lt;b&gt;NEWS: &lt;/b&gt;{this.state.news}&lt;/p&gt;
										&lt;p&gt;&lt;b&gt;Gender: &lt;/b&gt;{patient.gender}&lt;/p&gt;
										&lt;p&gt;&lt;b&gt;Ward: &lt;/b&gt;{patient.location}&lt;/p&gt;
									&lt;/div&gt;
									&lt;div className=&quot;col s6&quot;&gt;

										&lt;h6&gt;Contact Information&lt;/h6&gt;
										&lt;p&gt;&lt;b&gt;Name: &lt;/b&gt;{contact.displayName}&lt;/p&gt;
										&lt;p&gt;&lt;b&gt;Number: &lt;/b&gt;{contact.number}&lt;/p&gt;
									&lt;/div&gt;
								&lt;/div&gt;
							&lt;/div&gt;
							&lt;div className=&quot;card-action&quot;&gt;
								&lt;a className=&quot;teal-text text-darken-1&quot; onClick={this.popupHistory.bind(this)}&gt;History&lt;/a&gt;
								&lt;a className=&quot;teal-text text-darken-1&quot; onClick={this.popupAE.bind(this)}&gt;A-E Report&lt;/a&gt;
								&lt;a className=&quot;teal-text text-darken-1&quot; onClick={this.popupWarningScoreHistory.bind(this)}&gt;Vitals Chart&lt;/a&gt;
							&lt;/div&gt;
						&lt;/div&gt;
					&lt;/div&gt;
				&lt;/div&gt;
				&lt;div className=&quot;col s12&quot;&gt;
					&lt;Vitals submit={this.submitVitals} history={this.state.patientReports} /&gt;
				&lt;/div&gt;
				&lt;HistoryReport
					{...this.state.report}
					patientName={patient.displayName}
					reportLoaded={this.state.reportLoaded}
				/&gt;
				&lt;VitalCharts refCb={ref =&gt; this.newsChart = ref} history={this.state.patientReports.reverse()} /&gt;
			&lt;/div&gt;
		)
	}
}

export default Patient
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
