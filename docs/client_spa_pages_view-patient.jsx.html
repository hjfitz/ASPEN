<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>client/spa/pages/view-patient.jsx - Documentation</title>

    <script src="scripts/hljs/highlight.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/hljs.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdmitPatient.html">AdmitPatient</a><ul class='methods'><li data-type='method'><a href="AdmitPatient.html#admit">admit</a></li><li data-type='method'><a href="AdmitPatient.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="AdmitPatient.html#getImg">getImg</a></li><li data-type='method'><a href="AdmitPatient.html#render">render</a></li><li data-type='method'><a href="AdmitPatient.html#setImg">setImg</a></li></ul></li><li><a href="App.html">App</a><ul class='methods'><li data-type='method'><a href="App.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="App.html#onChange">onChange</a></li><li data-type='method'><a href="App.html#render">render</a></li></ul></li><li><a href="global.html#Contact">Contact</a><ul class='methods'><li data-type='method'><a href="global.html#Contact#insert">insert</a></li><li data-type='method'><a href="global.html#Contact#populate">populate</a></li></ul></li><li><a href="CreateWard.html">CreateWard</a><ul class='methods'><li data-type='method'><a href="CreateWard.html#.validateForms">validateForms</a></li><li data-type='method'><a href="CreateWard.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="CreateWard.html#makeWard">makeWard</a></li><li data-type='method'><a href="CreateWard.html#render">render</a></li></ul></li><li><a href="DiagnosticReport.html">DiagnosticReport</a><ul class='methods'><li data-type='method'><a href="DiagnosticReport.html#fhir">fhir</a></li><li data-type='method'><a href="DiagnosticReport.html#fhirLinked">fhirLinked</a></li></ul></li><li><a href="Encounter.html">Encounter</a><ul class='methods'><li data-type='method'><a href="Encounter.html#delete">delete</a></li><li data-type='method'><a href="Encounter.html#fhir">fhir</a></li><li data-type='method'><a href="Encounter.html#insert">insert</a></li><li data-type='method'><a href="Encounter.html#populate">populate</a></li><li data-type='method'><a href="Encounter.html#update">update</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#.lookup">lookup</a></li><li data-type='method'><a href="Location.html#fhir">fhir</a></li><li data-type='method'><a href="Location.html#populate">populate</a></li></ul></li><li><a href="module.exports.html">exports</a></li><li><a href="NEWSError.html">NEWSError</a></li><li><a href="Observation.html">Observation</a><ul class='methods'><li data-type='method'><a href="Observation.html#fhir">fhir</a></li></ul></li><li><a href="OperationOutcome.html">OperationOutcome</a><ul class='methods'><li data-type='method'><a href="OperationOutcome.html#makeResponse">makeResponse</a></li></ul></li><li><a href="Patient.html">Patient</a><ul class='methods'><li data-type='method'><a href="Patient.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="Patient.html#delete">delete</a></li><li data-type='method'><a href="Patient.html#delete">delete</a></li><li data-type='method'><a href="Patient.html#fhir">fhir</a></li><li data-type='method'><a href="Patient.html#insert">insert</a></li><li data-type='method'><a href="Patient.html#populate">populate</a></li><li data-type='method'><a href="Patient.html#popupAE">popupAE</a></li><li data-type='method'><a href="Patient.html#popupHistory">popupHistory</a></li><li data-type='method'><a href="Patient.html#popupWarningScoreHistory">popupWarningScoreHistory</a></li><li data-type='method'><a href="Patient.html#render">render</a></li><li data-type='method'><a href="Patient.html#submitVitals">submitVitals</a></li><li data-type='method'><a href="Patient.html#update">update</a></li></ul></li><li><a href="Questionnaire.html">Questionnaire</a><ul class='methods'><li data-type='method'><a href="Questionnaire.html#toggleQuestionnaire">toggleQuestionnaire</a></li></ul></li><li><a href="Redirect.html">Redirect</a><ul class='methods'><li data-type='method'><a href="Redirect.html#componentWillMount">componentWillMount</a></li><li data-type='method'><a href="Redirect.html#render">render</a></li></ul></li><li><a href="SearchPatient.html">SearchPatient</a><ul class='methods'><li data-type='method'><a href="SearchPatient.html#componentWillUnmount">componentWillUnmount</a></li><li data-type='method'><a href="SearchPatient.html#render">render</a></li><li data-type='method'><a href="SearchPatient.html#renderPatients">renderPatients</a></li><li data-type='method'><a href="SearchPatient.html#search">search</a></li></ul></li><li><a href="Ward.html">Ward</a><ul class='methods'><li data-type='method'><a href="Ward.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="Ward.html#render">render</a></li><li data-type='method'><a href="Ward.html#renderPatients">renderPatients</a></li></ul></li><li><a href="WardList.html">WardList</a><ul class='methods'><li data-type='method'><a href="WardList.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="WardList.html#createWardList">createWardList</a></li><li data-type='method'><a href="WardList.html#render">render</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#AlcoholQuestionnaire">AlcoholQuestionnaire</a></li><li><a href="global.html#Breadcrumbs">Breadcrumbs</a></li><li><a href="global.html#calculate">calculate</a></li><li><a href="global.html#checkPass">checkPass</a></li><li><a href="global.html#createOutcome">createOutcome</a></li><li><a href="global.html#DecButton">DecButton</a></li><li><a href="global.html#decodeJWTPayload">decodeJWTPayload</a></li><li><a href="global.html#Diet">Diet</a></li><li><a href="global.html#dispatchMouseUp">dispatchMouseUp</a></li><li><a href="global.html#doModal">doModal</a></li><li><a href="global.html#DrugTable">DrugTable</a></li><li><a href="global.html#emulateTouch">emulateTouch</a></li><li><a href="global.html#Exercise">Exercise</a></li><li><a href="global.html#fhirBase">fhirBase</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#getCurrentUrl">getCurrentUrl</a></li><li><a href="global.html#getDate">getDate</a></li><li><a href="global.html#getGiven">getGiven</a></li><li><a href="global.html#getJwtPayload">getJwtPayload</a></li><li><a href="global.html#getPatientReport">getPatientReport</a></li><li><a href="global.html#getStyle">getStyle</a></li><li><a href="global.html#handleUser">handleUser</a></li><li><a href="global.html#HistoryReport">HistoryReport</a></li><li><a href="global.html#IncButton">IncButton</a></li><li><a href="global.html#Input">Input</a></li><li><a href="global.html#lengthPolicy">lengthPolicy</a></li><li><a href="global.html#Loader">Loader</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#noop">noop</a></li><li><a href="global.html#normalisePatientInfo">normalisePatientInfo</a></li><li><a href="global.html#normalisePatientReports">normalisePatientReports</a></li><li><a href="global.html#OtherQuestions">OtherQuestions</a></li><li><a href="global.html#PatientDemographicInfo">PatientDemographicInfo</a></li><li><a href="global.html#score">score</a></li><li><a href="global.html#scoreBP">scoreBP</a></li><li><a href="global.html#scoreCons">scoreCons</a></li><li><a href="global.html#scoreHeart">scoreHeart</a></li><li><a href="global.html#scoreOxy">scoreOxy</a></li><li><a href="global.html#scoreResp">scoreResp</a></li><li><a href="global.html#scoreSuppOxy">scoreSuppOxy</a></li><li><a href="global.html#scoreTemp">scoreTemp</a></li><li><a href="global.html#Select">Select</a></li><li><a href="global.html#showLogin">showLogin</a></li><li><a href="global.html#SignOff">SignOff</a></li><li><a href="global.html#toTitle">toTitle</a></li><li><a href="global.html#Welcome">Welcome</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">client/spa/pages/view-patient.jsx</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {h, Component} from 'preact'
import M from 'materialize-css'
import {Loader, Vitals, HistoryReport, VitalCharts} from '../Partial'
import {fhirBase, doModal, toTitle} from '../util'
import WarningScore from '../WarningScore'

import '../styles/view-patient.scss'
/**
 * Normalise api response for ease of manipulation in this component
 * @param {object} fhirResponse API response
 * @returns {object} normalised fhir response
 */
const normalisePatientInfo = (fhirResponse) => {
	const {
		contact: [contact],
		photo: [photo],
		name: [name],
		id,
		gender,
		reference,
	} = fhirResponse
	return ({
		patient: {
			displayName: `${name.prefix} ${name.text}`,
			photo: photo ? photo.url : '',
			id,
			gender,
			location: reference,
		},
		contact: {
			displayName: `${contact.name.prefix} ${contact.name.text}`,
			number: contact.telecom[0].value,
		},

	})
}

/**
 * makes the fhir response easier to work with
 * @param {object[]} patReport Patient diagnostic report fro fhir api
 * @returns {object[]} formatted object: [{oxygen_saturation: 11, body_temp: 37 ...}]
 */
const normalisePatientReports = patReport => patReport
	.map(report => ({
		...report.result.reduce((acc, cur) => {
			acc[cur.code.text] = cur.valueQuantity.value
			return acc
		}, {}),
		date: new Date(report.meta.lastUpdated)}
	))


/**
 * Hit /Diagnostics for list of 10 most recent patient reports
 * @param {number} id patient ID
 * @param {number} pageNo which page number to visit
 * @returns {AxiosPromise&lt;any>} request to API
 */
const getPatientReport = (id, pageNo = 0) => fhirBase.get(
	`Diagnostics?patient=${id}`
	+ '&amp;result=true'
	+ '&amp;_count=10'
	+ `&amp;pageNo=${pageNo}`,
)

class Patient extends Component {
	/**
	 * Patient information component
	 * @param {object} props component props
	 */
	constructor(props) {
		super(props)
		this.state = {
			loaded: false,
			patientInfo: null,
			pageNo: 0,
			report: {},
			reportLoaded: false,
		}
		this.submitVitals = this.submitVitals.bind(this)
	}

	/**
	 * fetch patient data from /Encounter on form load
	 */
	async componentDidMount() {
		const {patient_id: id} = this.props
		const [{data}, {data: patientReport}] = await Promise.all([
			fhirBase.get(`Encounter?class=admission&amp;patient_id=${id}&amp;_include=Encounter:patient`),
			getPatientReport(id, this.state.pageNo),
		])

		const patientInfo = normalisePatientInfo({...data[0].subject, ...data[0].location[0]})
		const patientReports = normalisePatientReports(patientReport) // comes pre-sorted from API
		const ews = new WarningScore(patientReports[0])
		this.setState({
			patientInfo,
			loaded: true,
			patientReports,
			news: ews.score(),
		})
	}


	/**
	 * Submit data to API and repopulate vital chart
	 * @param {FormData} diagnosticReport fields in &lt;vitals />
	 */
	async submitVitals(diagnosticReport) {
		diagnosticReport.append('patient_id', this.props.patient_id)
		try {
			const {data} = await fhirBase.post('/Diagnostics', diagnosticReport)
			M.toast({html: data.details.text})
			const {data: patientReport} = await getPatientReport(this.props.patient_id, this.state.pageNo)
			const patientReports = normalisePatientReports(patientReport)
			const ews = new WarningScore(patientReports[0])
			this.setState({
				loaded: true,
				patientInfo: this.state.patientInfo,
				patientReports,
				news: ews.score(),
			})
		} catch (err) {
			console.error(err.response)
			doModal('Error', `There was an error submitting this report:&lt;/p>&lt;p>${err}&lt;/p>`)
		}
	}

	/**
	 * ? Keep an eye on `history.back`, see if it malfunctions
	 */
	async delete() {
		const {data} = await fhirBase.delete(`/Patient/${this.props.patient_id}`)
		const sev = data.issue[0].severity
		doModal(toTitle(sev), data.issue[0].details.text)
		if (sev === 'success') window.history.back()
	}

	/**
	 * get history data and then update state
	 * once state is updated, can be passed to history component as props via re-render
	 * after this, pop-up the modal
	 * @param {Event} ev click
	 */
	async popupHistory(ev) {
		ev.preventDefault()
		const {patient_id} = this.props
		const {data: report} = await fhirBase.get(`/History/${patient_id}`)
		this.setState({
			loaded: this.state.loaded,
			patientInfo: this.state.patientInfo,
			patientReports: this.state.patientReports,
			news: this.state.news,
			report,
			reportLoaded: true,
		}, () => {
			const repModal = document.querySelector('.modal.history-report-modal')
			const instance = M.Modal.getInstance(repModal) || M.Modal.init(repModal)
			instance.open()
		})
	}

	/**
	 * invoked on click of A-E
	 * placeholder until invoked
	 * @param {Event} ev Click event
	 */
	async popupAE(ev) {
		ev.preventDefault()
		console.log(this)
	}

	/**
	 * pop up a modal and update tabs
	 * @param {Event} ev click event
	 */
	popupWarningScoreHistory(ev) {
		ev.preventDefault()
		const instance = M.Modal.getInstance(this.newsChart) || M.Modal.init(this.newsChart, {
			onOpenEnd() {
				const tabs = document.querySelector('.tabs.chart-tabs')
				M.Tabs.init(tabs)
				console.log('opening tabs')
			},
		})
		instance.open()
	}

	/**
	 * Render our patient info
	 * @returns {preact.VNode} patient information or loading icon
	 */
	render() {
		if (!this.state.loaded) return &lt;Loader />
		const {patient, contact} = this.state.patientInfo
		return (
			&lt;div className="row">
				&lt;div className="col s12">
					&lt;div className="card horizontal patient-view">
						&lt;div className="card-image">
							&lt;img alt={patient.displayName} src={patient.photo || '/img/patient-placeholder.webp'} />
						&lt;/div>
						&lt;div className="card-stacked">
							&lt;div className="card-content">
								&lt;i className="material-icons right clickable" onClick={this.delete.bind(this)}>close&lt;/i>
								&lt;div className="row">
									&lt;div className="col s12">
										&lt;span className="card-title">{patient.displayName}&lt;/span>
									&lt;/div>
								&lt;/div>
								&lt;div className="row">
									&lt;div className="col s6">
										&lt;h6>Patient Information&lt;/h6>
										&lt;p>&lt;b>NEWS: &lt;/b>{this.state.news}&lt;/p>
										&lt;p>&lt;b>Gender: &lt;/b>{patient.gender}&lt;/p>
										&lt;p>&lt;b>Ward: &lt;/b>{patient.location}&lt;/p>
									&lt;/div>
									&lt;div className="col s6">

										&lt;h6>Contact Information&lt;/h6>
										&lt;p>&lt;b>Name: &lt;/b>{contact.displayName}&lt;/p>
										&lt;p>&lt;b>Number: &lt;/b>{contact.number}&lt;/p>
									&lt;/div>
								&lt;/div>
							&lt;/div>
							&lt;div className="card-action">
								&lt;a className="teal-text text-darken-1" onClick={this.popupHistory.bind(this)}>History&lt;/a>
								&lt;a className="teal-text text-darken-1" onClick={this.popupAE.bind(this)}>A-E Report&lt;/a>
								&lt;a className="teal-text text-darken-1" onClick={this.popupWarningScoreHistory.bind(this)}>Vitals Chart&lt;/a>
							&lt;/div>
						&lt;/div>
					&lt;/div>
				&lt;/div>
				&lt;div className="col s12">
					&lt;Vitals submit={this.submitVitals} history={this.state.patientReports} />
				&lt;/div>
				&lt;HistoryReport
					{...this.state.report}
					patientName={patient.displayName}
					reportLoaded={this.state.reportLoaded}
				/>
				&lt;VitalCharts refCb={ref => this.newsChart = ref} history={this.state.patientReports.reverse()} />
			&lt;/div>
		)
	}
}

export default Patient
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Apr 26 2019 15:33:49 GMT+0100 (British Summer Time) using the <a href="https://github.com/contentful/contentful-sdk-jsdoc">contentful-sdk-jsdoc</a> theme.
</footer>

<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
