<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>server/fhir/classes/Patient.js - Documentation</title>

    <script src="scripts/hljs/highlight.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/hljs.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Contact.html">Contact</a><ul class='methods'><li data-type='method'><a href="Contact.html#insert">insert</a></li><li data-type='method'><a href="Contact.html#populate">populate</a></li></ul></li><li><a href="CreatePatient.html">CreatePatient</a><ul class='methods'><li data-type='method'><a href="CreatePatient.html#admit">admit</a></li><li data-type='method'><a href="CreatePatient.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="CreatePatient.html#componentDidUpdate">componentDidUpdate</a></li><li data-type='method'><a href="CreatePatient.html#getPicture">getPicture</a></li><li data-type='method'><a href="CreatePatient.html#render">render</a></li></ul></li><li><a href="CreateWard.html">CreateWard</a><ul class='methods'><li data-type='method'><a href="CreateWard.html#.validateForms">validateForms</a></li><li data-type='method'><a href="CreateWard.html#componentDidMount">componentDidMount</a></li><li data-type='method'><a href="CreateWard.html#makeWard">makeWard</a></li><li data-type='method'><a href="CreateWard.html#render">render</a></li></ul></li><li><a href="DiagnosticReport.html">DiagnosticReport</a><ul class='methods'><li data-type='method'><a href="DiagnosticReport.html#fhir">fhir</a></li><li data-type='method'><a href="DiagnosticReport.html#fhirLinked">fhirLinked</a></li></ul></li><li><a href="Encounter.html">Encounter</a><ul class='methods'><li data-type='method'><a href="Encounter.html#delete">delete</a></li><li data-type='method'><a href="Encounter.html#fhir">fhir</a></li><li data-type='method'><a href="Encounter.html#insert">insert</a></li><li data-type='method'><a href="Encounter.html#populate">populate</a></li><li data-type='method'><a href="Encounter.html#update">update</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#.lookup">lookup</a></li><li data-type='method'><a href="Location.html#getFhir">getFhir</a></li></ul></li><li><a href="Observation.html">Observation</a><ul class='methods'><li data-type='method'><a href="Observation.html#fhir">fhir</a></li></ul></li><li><a href="OperationOutcome.html">OperationOutcome</a><ul class='methods'><li data-type='method'><a href="OperationOutcome.html#makeResponse">makeResponse</a></li></ul></li><li><a href="Patient.html">Patient</a><ul class='methods'><li data-type='method'><a href="Patient.html#delete">delete</a></li><li data-type='method'><a href="Patient.html#fhir">fhir</a></li><li data-type='method'><a href="Patient.html#insert">insert</a></li><li data-type='method'><a href="Patient.html#populate">populate</a></li><li data-type='method'><a href="Patient.html#update">update</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#Breadcrumbs">Breadcrumbs</a></li><li><a href="global.html#getJwtPayload">getJwtPayload</a></li><li><a href="global.html#Input">Input</a></li><li><a href="global.html#Loader">Loader</a></li><li><a href="global.html#Select">Select</a></li><li><a href="global.html#Welcome">Welcome</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">server/fhir/classes/Patient.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const mimeTypes = require('mime-types')
const sha1 = require('crypto-js/sha1')
const fs = require('fs')
const path = require('path')
const shortid = require('shortid')
const mime = require('mime-types')


const logger = require('../../logger')
const {knex} = require('../../db')
const Contact = require('./Contact')

class Patient {
	/**
	 * Fhir wrapper for patient information
	 * @param {object} params patient params
	 * @param {boolean} params.active whether the patient is still active in the hospital
	 * @param {string} params.id DB id for the patient
	 * @param {string} params.fullname fullname of patient
	 * @param {string} params.given patient family name
	 * @param {string} params.prefix patient prefix (Mr, Miss)
	 * @param {string} params.gender patient gender: male, female or other
	 * @param {Date} params.last_updated when the patient was last updated
	 * @param {string} params.photo_url where the patient url is stored
	 * @param {string} params.family patient family name (surname)
	 */
	constructor(params) {
		const {active, id, fullname, given, prefix, gender, last_updated, photo, family} = params
		this.active = active
		this.loaded = false
		this.id = id
		this.fullname = fullname
		this.given = given
		this.prefix = prefix
		this.gender = gender
		this.last_updated = last_updated
		this.photo = photo
		this.family = family
		this.meta = {file: 'fhir/classes/Patient.js'}
		this.required = ['active', 'fullname', 'given', 'prefix', 'gender', 'contact_id']
		this.values = [...this.required, 'family', 'last_updated']
	}

	/**
	 * Based on this.id, populate the patient with database info
	 * @return {boolean} populated or not
	 */
	async populate() {
		const {meta, id} = this
		if (!id) {
			logger.warn('Attempted to populate with invalid ID', meta)
			return false
		}
		try {
			const [patient] = await knex('patient').select().where({patient_id: id})
			this.loaded = true
			Object.keys(patient).forEach(key => this[key] = patient[key])
			this.contact = new Contact({contact_id: patient.contact_id})
			await this.contact.populate()
			return true
		} catch (err) {
			logger.error('Unable to populate patient', {...this.meta, func: 'populate()'})
			logger.error(err, {...this.meta, func: 'populate()'})
			return false
		}
	}

	/**
	 * Attempt to insert a patient with params provided
	 * @returns {boolean} inserted or not
	 */
	async insert() {
		const isValid = this.required.filter(key => !(this[key]))
		if (isValid.length) {
			logger.warn('unable to create patient', {...this.meta, func: 'insert()'})
			logger.silly(JSON.stringify(isValid), {...this.meta, func: 'insert()'})
			return false
		}
		// create object
		this.last_updated = new Date()
		this.active = true
		const obj = this.values.reduce((acc, cur) => {
			acc[cur] = this[cur]
			return acc
		}, {})
		if (this.photo) {
			logger.info('handling image', {...this.meta, func: 'insert()'})
			const ext = mime.extension(this.photo.mimetype)
			const photo_url = path.join('/patient', `${this.given}-${shortid.generate()}.${ext}`)
			const newPath = path.join(process.cwd(), photo_url)
			logger.debug(`moved image to ${newPath}`, {...this.meta, func: 'insert()'})
			this.photo.mv(newPath)
			obj.photo_url = photo_url
		}
		// make query
		const [resp] = await knex('patient').insert(obj).returning(['patient_id', ...this.values])
		return resp
	}

	/**
	 * Attempts to delete a patient based on this.id
	 * @returns {boolean} Deleted or nah
	 */
	async delete() {
		try {
			await knex('patient').delete('patient', this.id)
			return true
		} catch (err) {
			logger.error('Unable to delete patient', {...this.meta, func: 'delete()'})
			logger.error(err, {...this.meta, func: 'delete()'})
			return false
		}
	}

	/**
	 * Attempts to perform UPDATE on the database with this.id and params provided
	 * @returns {boolean} Updated or not
	 */
	async update() {
		const toUpdate = this.values
			.filter(val => this[val])
			.reduce((acc, cur) => {
				acc[cur] = this[cur]
				return acc
			}, {})
		if (Object.keys(toUpdate).length) {
			logger.warn(`Trying to update ${this.id}, but no params`, this.meta)
			return false
		}
		try {
			await knex('patient').update(toUpdate)
			logger.debug(`Successfully updated ${Object.keys(toUpdate).join(', ')}`, this.meta)
			await this.populate()
		} catch (err) {
			logger.error('Unable to update patient', {...this.meta, func: 'update()'})
			logger.error(err, {...this.meta, func: 'update()'})
			return false
		}
		return true
	}

	/**
	 * Formats patient to standard fhir patient
	 * @returns {object} patient info formatted in fhir
	 */
	async fhir() {
		await this.populate()
		const {contact} = this
		if (!contact) return false
		const local = path.join(process.cwd(), this.photo_url || '')
		const photo = this.photo_url &amp;&amp; fs.existsSync(local)
			? [{
				contentType: mimeTypes.lookup(local),
				url: this.photo_url,
				hash: sha1(fs.readFileSync(local)).toString(),
			}]
			: []
		return {
			identifier: [{
				use: 'usual',
				system: 'urn:ietf:rfc:3986',
				value: 'database id',
				assigner: 'SoN',
			}],
			resourceType: 'Patient',
			id: this.id,
			active: this.active,
			name: [{
				use: 'usual',
				text: this.fullname,
				family: this.family,
				given: this.given,
				prefix: this.prefix.split(' '),
			}],
			gender: this.gender,
			photo,
			contact: [{
				name: {
					use: 'usual',
					text: contact.fullname,
					family: contact.family,
					given: contact.given,
					prefix: contact.prefix.split(' '),
					telecom: [{
						system: 'phone',
						value: contact.phone,
						use: 'home',
					}],
				},
			}],
		}
	}
}

module.exports = Patient
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Feb 03 2019 14:26:28 GMT+0000 (Greenwich Mean Time) using the <a href="https://github.com/contentful/contentful-sdk-jsdoc">contentful-sdk-jsdoc</a> theme.
</footer>

<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
